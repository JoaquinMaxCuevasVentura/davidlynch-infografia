<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAVID LYNCH | Infografía</title>

    <!-- FUENTES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- ICONOS -->
    <link href="https://cdn.jsdelivr.net/npm/dflip/css/themify-icons.min.css" rel="stylesheet" type="text/css">

    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-color: #050505;      
            --accent-color: #dc6b2f;  
            --text-main: #FFFFFF;     
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body, html {
            height: 100%; 
            margin: 0;
            background-color: var(--bg-color);
            font-family: 'Archivo', sans-serif;
            overflow: hidden;
        }

        /* FONDO GRANULADO */
        #grained-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 0; 
            pointer-events: none;
        }

        /* CONTENEDOR PRINCIPAL DEL VISOR */
        #viewer-container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
        }
        
        #viewer-container:active {
            cursor: grabbing;
        }

        /* Canvas del PDF */
        #pdf-render {
            max-width: 90%;
            height: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: none; /* Oculto hasta que cargue */
        }

        #pdf-render.loaded {
            display: block;
        }

        /* --- LOADER --- */
        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            color: var(--text-main);
        }

        #loader.hidden {
            display: none;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-text {
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.7;
        }

        /* --- ERROR MESSAGE --- */
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            color: var(--text-main);
            max-width: 400px;
            padding: 30px;
            display: none;
        }

        #error-message.show {
            display: block;
        }

        .error-icon {
            font-size: 48px;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .error-desc {
            font-size: 13px;
            color: #888;
            line-height: 1.6;
        }

        /* --- BARRA DE HERRAMIENTAS --- */
        #custom-toolbar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            padding: 0;
            gap: 25px; 
        }

        /* Botones */
        .custom-btn {
            background: transparent;
            border: none;
            color: #AAAAAA;
            cursor: pointer;
            width: auto;  
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease, transform 0.2s ease, text-shadow 0.2s ease;
            padding: 0;
            outline: none;
            position: relative; 
            pointer-events: auto;
        }

        .custom-btn:focus-visible {
            outline: 2px solid var(--accent-color);
            outline-offset: 4px;
        }

        /* Iconos */
        .custom-btn i {
            font-size: 20px; 
            line-height: 1;
            display: block;
            font-weight: normal;
        }

        /* Ajuste óptico icono INFO */
        #btn-info i { 
            font-size: 17px; 
            position: relative;
            top: -1px;
        }

        /* Hover y Active */
        .custom-btn:hover, 
        .custom-btn.active {
            color: var(--accent-color);
            transform: scale(1.2);
            text-shadow: 0 0 15px rgba(220, 107, 47, 0.6);
        }

        /* --- MODAL INFO --- */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            z-index: 10000; 
            display: flex;
            justify-content: center; 
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show { 
            opacity: 1; 
            visibility: visible;
        }

        .modal-content {
            color: #fff; 
            max-width: 500px; 
            width: 80%;
            text-align: center; 
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-line { 
            width: 40px; 
            height: 2px; 
            background-color: var(--accent-color); 
            margin: 20px auto; 
        }

        .modal-title { 
            font-size: 24px; 
            font-weight: 800; 
            margin-bottom: 5px; 
            text-transform: uppercase; 
            letter-spacing: 3px; 
        }

        .modal-subtitle { 
            font-size: 11px; 
            color: var(--accent-color); 
            margin-bottom: 30px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-weight: 600; 
        }

        .modal-body { 
            font-size: 14px; 
            color: #ccc; 
            line-height: 1.6; 
            font-weight: 300; 
        }

        .modal-body p {
            margin: 0;
        }

        .modal-note { 
            margin-top: 30px; 
            font-size: 10px; 
            color: #666; 
            border-top: 1px solid #222; 
            padding-top: 15px; 
        }
        
        .close-modal { 
            position: absolute; 
            top: -50px; 
            right: 0; 
            color: #666; 
            font-size: 30px; 
            cursor: pointer; 
            transition: color 0.2s ease;
            font-weight: 100; 
            font-family: sans-serif;
            background: none;
            border: none;
            padding: 5px;
            line-height: 1;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: var(--accent-color);
            outline: none;
        }
    </style>
</head>
<body>

    <!-- FONDO GRANULADO -->
    <div id="grained-container"></div>

    <!-- LOADER -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Cargando infografía...</div>
    </div>

    <!-- ERROR MESSAGE -->
    <div id="error-message">
        <div class="error-icon">⚠</div>
        <div class="error-title">No se pudo cargar el PDF</div>
        <div class="error-desc">
            Verifica que el archivo PDF existe y que la ruta es correcta. 
            También asegúrate de que estás ejecutando esto desde un servidor web.
        </div>
    </div>

    <!-- MODAL INFO -->
    <div id="infoModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <button class="close-modal" id="close-modal-btn" aria-label="Cerrar">✕</button>
            <h1 class="modal-title" id="modal-title">DAVID LYNCH</h1>
            <div class="modal-subtitle">DECODIFICACIÓN FÍLMICA [INFOGRAFÍA]</div>
            <div class="modal-line"></div>
            <div class="modal-body">
                <p>INVESTIGACIÓN, REDACCIÓN E ILUSTRACIÓN<br>
                <strong style="color:white; font-size:15px; letter-spacing:1px;">Joaquin Max Cuevas Ventura</strong><br>
                2021</p>
                <div class="modal-note">
                    Nota: Este fue un ejercicio de diseño de información, por lo que esta publicación constituye un proyecto académico con fines pedagógicos y de exhibición de portafolio, exento de cualquier propósito comercial o de lucro.
                </div>
            </div>
        </div>
    </div>

    <!-- BARRA DE HERRAMIENTAS -->
    <div id="custom-toolbar">
        <button class="custom-btn" id="btn-zoom-in" title="Acercar" aria-label="Acercar"><i class="ti-zoom-in"></i></button>
        <button class="custom-btn" id="btn-zoom-out" title="Alejar" aria-label="Alejar"><i class="ti-zoom-out"></i></button>
        <button class="custom-btn" id="btn-full" title="Pantalla Completa" aria-label="Pantalla Completa"><i class="ti-fullscreen"></i></button>
        <button class="custom-btn" id="btn-info" title="Información" aria-label="Información"><i class="ti-info-alt"></i></button>
    </div>

    <!-- CONTENEDOR DEL PDF -->
    <div id="viewer-container">
        <canvas id="pdf-render"></canvas>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/grained/0.0.2/grained.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <script>
        (function() {
            'use strict';

            // ==========================================
            // CONFIGURACIÓN
            // ==========================================
            const CONFIG = {
                pdfUrl: 'FILMOGRAFIADAVIDLYNCH_InfografiaCompleta_WEB-FINAL_v01_18122025.pdf',
                pdfWorkerUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js',
                pdfRenderScale: 2.5,
                panzoom: {
                    maxScale: 6,
                    minScale: 0.1,
                    startScale: 0.4,
                    contain: 'outside',
                    cursor: 'grab'
                },
                grained: {
                    animate: true,
                    patternWidth: 100,
                    patternHeight: 100,
                    grainOpacity: 0.05,
                    grainDensity: 1,
                    grainWidth: 1,
                    grainHeight: 1
                }
            };

            // ==========================================
            // ELEMENTOS DOM (cacheados)
            // ==========================================
            const DOM = {
                grainedContainer: document.getElementById('grained-container'),
                loader: document.getElementById('loader'),
                errorMessage: document.getElementById('error-message'),
                modal: document.getElementById('infoModal'),
                btnInfo: document.getElementById('btn-info'),
                btnCloseModal: document.getElementById('close-modal-btn'),
                btnZoomIn: document.getElementById('btn-zoom-in'),
                btnZoomOut: document.getElementById('btn-zoom-out'),
                btnFull: document.getElementById('btn-full'),
                canvas: document.getElementById('pdf-render'),
                container: document.getElementById('viewer-container')
            };

            // Estado de la aplicación
            let panzoomInstance = null;

            // ==========================================
            // MÓDULO: GRANULADO
            // ==========================================
            function initGrained() {
                if (typeof grained !== 'function') {
                    console.warn('Grained library not loaded');
                    return;
                }
                
                try {
                    grained('#grained-container', CONFIG.grained);
                } catch (e) {
                    console.warn('Error initializing grained effect:', e.message);
                }
            }

            // ==========================================
            // MÓDULO: MODAL
            // ==========================================
            const Modal = {
                isOpen: false,

                open() {
                    this.isOpen = true;
                    DOM.modal.classList.add('show');
                    DOM.btnInfo.classList.add('active');
                    DOM.btnCloseModal.focus();
                },

                close() {
                    this.isOpen = false;
                    DOM.modal.classList.remove('show');
                    DOM.btnInfo.classList.remove('active');
                    DOM.btnInfo.focus();
                },

                toggle() {
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                },

                init() {
                    // Botón info
                    DOM.btnInfo.addEventListener('click', () => this.toggle());
                    
                    // Botón cerrar
                    DOM.btnCloseModal.addEventListener('click', () => this.close());
                    
                    // Click en overlay
                    DOM.modal.addEventListener('click', (e) => {
                        if (e.target === DOM.modal) {
                            this.close();
                        }
                    });
                    
                    // Tecla ESC
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            this.close();
                        }
                    });
                }
            };

            // ==========================================
            // MÓDULO: FULLSCREEN
            // ==========================================
            const Fullscreen = {
                toggle() {
                    const doc = document.documentElement;

                    if (!this.isFullscreen()) {
                        // Entrar en fullscreen (con prefijos para compatibilidad)
                        if (doc.requestFullscreen) {
                            doc.requestFullscreen();
                        } else if (doc.webkitRequestFullscreen) {
                            doc.webkitRequestFullscreen();
                        } else if (doc.msRequestFullscreen) {
                            doc.msRequestFullscreen();
                        }
                    } else {
                        // Salir de fullscreen
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                    }
                },

                isFullscreen() {
                    return !!(
                        document.fullscreenElement ||
                        document.webkitFullscreenElement ||
                        document.msFullscreenElement
                    );
                },

                init() {
                    DOM.btnFull.addEventListener('click', () => this.toggle());
                }
            };

            // ==========================================
            // MÓDULO: LOADER
            // ==========================================
            const Loader = {
                show() {
                    DOM.loader.classList.remove('hidden');
                    DOM.errorMessage.classList.remove('show');
                },

                hide() {
                    DOM.loader.classList.add('hidden');
                },

                showError() {
                    this.hide();
                    DOM.errorMessage.classList.add('show');
                }
            };

            // ==========================================
            // MÓDULO: PDF VIEWER
            // ==========================================
            const PDFViewer = {
                async init() {
                    // Verificar que PDF.js está cargado
                    if (typeof pdfjsLib === 'undefined') {
                        console.error('PDF.js library not loaded');
                        Loader.showError();
                        return;
                    }

                    // Configurar worker
                    pdfjsLib.GlobalWorkerOptions.workerSrc = CONFIG.pdfWorkerUrl;

                    try {
                        // Cargar documento PDF
                        const pdf = await pdfjsLib.getDocument(CONFIG.pdfUrl).promise;
                        
                        // Obtener primera página
                        const page = await pdf.getPage(1);
                        
                        // Renderizar
                        await this.renderPage(page);
                        
                        // Inicializar Panzoom después de renderizar
                        this.initPanzoom();
                        
                        // Ocultar loader y mostrar canvas
                        Loader.hide();
                        DOM.canvas.classList.add('loaded');

                    } catch (error) {
                        console.error('Error loading PDF:', error.message);
                        Loader.showError();
                    }
                },

                async renderPage(page) {
                    const ctx = DOM.canvas.getContext('2d');
                    const viewport = page.getViewport({ scale: CONFIG.pdfRenderScale });

                    // Ajustar tamaño del canvas
                    DOM.canvas.height = viewport.height;
                    DOM.canvas.width = viewport.width;

                    // Renderizar página
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;
                    console.log('PDF rendered successfully');
                },

                initPanzoom() {
                    // Verificar que Panzoom está disponible
                    if (typeof Panzoom !== 'function') {
                        console.error('Panzoom library not loaded');
                        return;
                    }

                    panzoomInstance = Panzoom(DOM.canvas, CONFIG.panzoom);

                    // Zoom con rueda del mouse
                    DOM.container.addEventListener('wheel', panzoomInstance.zoomWithWheel, { passive: false });

                    // Botones de zoom
                    DOM.btnZoomIn.addEventListener('click', () => {
                        if (panzoomInstance) panzoomInstance.zoomIn();
                    });

                    DOM.btnZoomOut.addEventListener('click', () => {
                        if (panzoomInstance) panzoomInstance.zoomOut();
                    });

                    console.log('Panzoom initialized');
                }
            };

            // ==========================================
            // INICIALIZACIÓN
            // ==========================================
            function init() {
                // Mostrar loader
                Loader.show();

                // Inicializar efecto granulado
                initGrained();

                // Inicializar modal
                Modal.init();

                // Inicializar fullscreen
                Fullscreen.init();

                // Inicializar visor de PDF
                PDFViewer.init();
            }

            // Esperar a que el DOM esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

        })();
    </script>

</body>
</html>
